extends layout
append styles
	link(rel='stylesheet', href='/stylesheets/index.css')
append scripts
	script(type='text/javascript', src='/javascripts/datepicker-zh-CN.js')
	script(type='text/javascript', src='/javascripts/moment.js')
	script(src='//webapi.amap.com/ui/1.0/main-async.js')

block append content
	#searchPanel
		//label 选择日期：
		input(type='text', name='from', id='from')
		&nbsp;
		button(type='button', onClick='doSearch();') 查询
	script(type='text/javascript').
		var pathSimplifierIns;
		var date = moment().subtract(1, 'day').format('YYYY-MM-DD');
		function init() {
			initAMapUI(); //这里调用initAMapUI初始化
			map = new AMap.Map('container', {
				resizeEnable: true,
			});
			map.on('complete', function() {
				doSearch();
			});
		}
		function doSearch() {
			if(pathSimplifierIns) {
				pathSimplifierIns.clearPathNavigators();
			}
			var searchDate = $('#from').val();
			if(searchDate != '') {
				if(!moment(searchDate).isAfter(date, 'day')) {
					date = searchDate;
				} else {
					alert('查询日期最晚为前一天！');
					$('#from').focus();
				}
			}
			var href = window.location.href;
			var hrefArray = href.split('/');
			var vehicle = hrefArray[hrefArray.length - 1];
			
			$.get('/showHistory/' + vehicle, function(results) {
				drawTrack(results.data);
			});
		}

		function drawTrack(data) {
			//加载PathSimplifier，loadUI的路径参数为模块名中 'ui/' 之后的部分 
			AMapUI.load(['ui/misc/PathSimplifier'], function(PathSimplifier) {

				if (!PathSimplifier.supportCanvas) {
						alert('当前环境不支持 Canvas！');
						return;
				}

				//启动页面
				doDraw(PathSimplifier, data);
			});
		}

		function doDraw(PathSimplifier, data) {
			
			//创建组件实例
			pathSimplifierIns = new PathSimplifier({
					zIndex: 100,
					map: map, //所属的地图实例
					data: [data],
					getPath: function(pathData, pathIndex) {
						//返回轨迹数据中的节点坐标信息，[AMap.LngLat, AMap.LngLat...] 或者 [[lng|number,lat|number],...]
						var path = [];
						for(var i = 0; i < data.length; i++) {
							path.push(new AMap.LngLat(data[i].lng, data[i].lat));
						}
						return path;
					},
					getHoverTitle: function(pathData, pathIndex, pointIndex) {
						//返回鼠标悬停时显示的信息
						if (pointIndex >= 0) {
								//鼠标悬停在某个轨迹节点上
								return pathData[pointIndex].vehicle + '，坐标:' + pathData[pointIndex].lng + ',' + pathData[pointIndex].lat + '，速度:' + pathData[pointIndex].veo + '，时间:' + date + ' ' + pathData[pointIndex].gpstime;
						}
						//鼠标悬停在节点之间的连线上
						return pathData[0].vehicle;
					},
					renderOptions: {
						//轨迹线的样式
						pathLineStyle: {
								strokeStyle: 'red',
								lineWidth: 6,
								dirArrowStyle: true
						}
					}
			});

			//创建一个巡航器
			var navg0 = pathSimplifierIns.createPathNavigator(0, {	//关联第1条轨迹
				speed: 10000,
				pathNavigatorStyle: {
					width: 16,
					height: 32,
					content: PathSimplifier.Render.Canvas.getImageContent('/images/car.png', onload, onerror),
					strokeStyle: null,
					fillStyle: null
				}
			});

			navg0.start();
		}
		

		$(function() {
			var dateFormat = "yy-mm-dd",
			from = $("#from").datepicker({
				//defaultDate: "+1w",
				changeMonth: true
			});
	 
			function getDate( element ) {
				var date;
				try {
					date = $.datepicker.parseDate( dateFormat, element.value );
				} catch( error ) {
					date = null;
				}
	 
				return date;
			}
		});